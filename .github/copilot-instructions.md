# Settings Framework - AI Coding Agent Instructions

## Architecture Overview

This is a **Swift macro-based framework** for type-safe UserDefaults access with SwiftUI integration. The codebase uses Swift 6.2 with strict concurrency checking.

**Core Components:**
- **Macro Layer** (`Sources/SettingsMacros/`): `@Settings` and `@Setting` macros generate code at compile time
- **Runtime Layer** (`Sources/Settings/MacroSettings/`, `MacroSetting/`): Protocol infrastructure that macros generate code against
- **SwiftUI Integration** (`Sources/Settings/SwiftUI/`): `@AppSetting` property wrapper with environment-based store injection
- **Mock Layer** (`Sources/SettingsMock/`): `UserDefaultsStoreMock` for testing and previews

**Key Design Decisions:**
- `__Settings_Container` protocol uses `any UserDefaultsStore` (existential types) instead of associated types to enable **dynamic store switching** at runtime (critical for SwiftUI mocking)
- Thread-safety via `OSAllocatedUnfairLock` instead of actor isolation to satisfy Swift 6 Sendable requirements for metatypes captured in Combine closures
- Double-underscore prefixed protocols (`__Settings_Container`, `__Attribute`) are internal implementation details generated by macros

## Critical Workflows

### Building & Testing
```bash
swift build --build-tests              # Build all targets including tests
swift test                             # Run all 92 tests
swift test --filter SettingsMacroExpansionTests  # Run specific test suite
```

### Release Process
1. Update `CHANGELOG.md` with new version entry
2. Commit changes locally
3. Push and create PR with label: `enhancement`, `breaking`, or `bugfix`
4. Squash-merge PR on GitHub
5. Tag release: `git tag X.Y.Z && git push --follow-tags`
6. Manually trigger `.github/workflows/release.yml` to create GitHub release

## Project Conventions

### Macro-Generated Code Pattern
```swift
// User writes:
@Settings(prefix: "app_")
struct AppSettings {
    @Setting static var username: String = "guest"
}

// Macro generates:
extension AppSettings: __Settings_Container {
    static let prefix = "app_"
    enum __Attribute_username: __AttributeNonOptional { /* ... */ }
    static var $username: __AttributeProxy<__Attribute_username>
}
```

**Key files:** `Sources/SettingsMacros/SettingsMacro.swift` (1495 lines), `SettingsMacro.swift` (268 lines)

### SwiftUI Integration Pattern
- Use `AppSettingValues` container for app-wide settings (no custom `@Settings` needed)
- Inject mock stores via `.environment(\.userDefaultsStore, UserDefaultsStoreMock())` in previews
- Global prefix configuration: `AppSettingValues.prefix = "myapp_"` (auto-generates from bundle ID if not set)

**Key file:** `Sources/Settings/SwiftUI/AppSetting.swift`

### Thread-Safety Requirements
- Never use `@MainActor` on containersâ€”breaks Sendable metatype requirements in Combine closures
- Use `OSAllocatedUnfairLock` for non-Sendable type access (iOS 17+, macOS 15+)
- Example: `AppSettingValues._config` protects both `store` and `prefix` with single lock

### Encoding Strategy
- Native property list types (Int, String, Bool, Date, Data, URL, Array, Dictionary) stored directly
- Codable types require `@Setting(encoding: .json)` or `.propertyList`
- Custom encoders: `@Setting(encoder: JSONEncoder(), decoder: JSONDecoder())`

**Key files:** `Sources/Settings/MacroSetting/Coding.swift`, protocol `PropertyListValue` in `Attribute.swift`

### Testing Patterns
- Macro expansion tests: Use `SwiftSyntaxMacrosTestSupport` in `Tests/SettingsMacroExpansionTests/`
- Runtime tests: Standard XCTest in `Tests/SettingsTests/`
- Mock testing: `UserDefaultsStoreMock()` with `.recordingEnabled` for verification

## Key Files Reference

- `Sources/Settings/MacroSettings/Settings_Container.swift` - Core protocol with store operations
- `Sources/Settings/MacroSetting/Attribute.swift` - Base protocol for generated attribute enums
- `Sources/SettingsMacros/SettingMacro.swift` - Generates getters/setters + attribute enums (~1500 lines)
- `Sources/SettingsMacros/SettingsMacro.swift` - Generates container conformance + prefix
- `Package.swift` - Multi-target SPM package with macro plugin support

## Common Pitfalls

1. **Don't add `@MainActor` to containers** - Causes "Type 'X' does not conform to the 'Sendable' protocol" errors in Combine publishers
2. **Protocol existentials aren't Sendable** - `any UserDefaultsStore` requires `OSAllocatedUnfairLock` wrapper
3. **Prefix validation** - Must be KVC-compliant (no dots allowed)
4. **Optional vs non-optional** - Optional properties generate `__AttributeOptional`, non-optional generate `__AttributeNonOptional` with different reset behavior
